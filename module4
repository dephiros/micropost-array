' choose pivot for quicksort algorithm. The pivot is the median of the last, first
' and middle index of the partition
Function choosePivot(a() As Double, left As Integer, right As Integer) As Double
    Dim middle As Integer, median As Integer
    middle = left + (right - left) / 2
    If a(left) < a(middle) Then
        median = middle
    Else
        median = left
    End If
    If a(median) > a(right) Then
        median = right
    End If
    choosePivot = median
End Function

' left is the index of the leftmost element of the subarray
' right is the index of the rightmost element of the subarray (inclusive)
' number of elements in subarray = right-left+1
Function partition(a() As Double, left As Integer, right As Integer, pivotIndex As Integer) As Integer
    Dim pivotValue As Double
    Dim i As Integer
    pivotValue = a(pivotIndex)
    swap a, pivotIndex, right
    storeIndex = left
    For i = left To right - 1
        If a(i) < pivotValue Then
            swap a, i, storeIndex
            storeIndex = storeIndex + 1
            End If
        Next i
    swap a, storeIndex, right
    partition = storeIndex
End Function


'Quick sort an array of double using in-place algorithm
Sub quicksort(a() As Double, left As Integer, right As Integer)
    Dim pivot As Integer
    If left < right Then
        pivot = choosePivot(a, left, right)
        pivot = partition(a, left, right, pivot)
        quicksort a, left, pivot - 1
        quicksort a, pivot, right
    End If
End Sub


' Swap a(one) and a(two). a is a double array
Sub swap(a() As Double, one As Integer, two As Integer)
    Dim temp As Double
    temp = a(one)
    a(one) = a(two)
    a(two) = temp
End Sub
